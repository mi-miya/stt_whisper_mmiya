# ローカル Whisper 音声入力システム (Windows用)

パソコンの中で動く「音声入力ツール」です。
ネットに繋がなくても、ショートカットキーやボタンひとつで声を文字にして、クリップボードにコピーしてくれます。

## ✨ 特徴
- **どこでも入力**: メモ帳、ブラウザ、Word、どこでも使えます
- **クリップボード経由**: カーソル位置に直接入力されるのではなく、クリップボードに保存されます。`Ctrl+V` でどこにでも貼り付け可能！
- **超軽量・常駐OK**: 待機中はパソコンのパワーをほとんど使いません。音声入力をする時だけ動くので、ずっと起動したままでも安心です
- **高速・高精度**: OpenAI Whisper を使ってローカル（自分のPC内）で変換します
- **安心プライバシー**: 音声データはネットに送信されません
- **かんたん操作**: マイクボタンをクリック、またはキーを押すだけ
- **効果音付き**: 画面を見なくても「ピッ」「ピピッ」と音でわかります
- **録音キャンセル**: いつでも `Esc` キーで録音を中止できます

---

## 📦 セットアップ手順（初回のみ）

### ステップ1: Python の確認

**Windowsユーザーの場合、Pythonは通常すでにインストールされています。** まずは確認してみましょう。

1. キーボードの **`Win` + `R`** を押します
2. 「`cmd`」と入力して `Enter` を押します
3. 黒い画面（コマンドプロンプト）が開いたら、次のように入力して `Enter` を押します:
   ```
   python --version
   ```
4. **「Python 3.x.x」のように表示されたら成功です！** ステップ2に進んでください

**もし「'python' は、内部コマンドまたは外部コマンド...」のようなエラーが出た場合:**
- Pythonがインストールされていないか、環境変数が設定されていない可能性があります
- [Python公式サイト](https://www.python.org/downloads/) から最新版をダウンロードしてインストールしてください
- **重要**: インストール時に必ず **"Add Python to PATH"** にチェックを入れてください！

> 💡 **環境変数のチェック方法**
> すでにPythonをインストールしたのに認識されない場合は、環境変数を確認してください:
> 1. 「スタートメニュー」→「設定」→「システム」→「詳細情報」→「システムの詳細設定」
> 2. 「環境変数」ボタンをクリック
> 3. 「Path」に Python のパスが含まれているか確認（例: `C:\Users\YourName\AppData\Local\Programs\Python\Python311\`）

---

### ステップ2: Whisper 本体（音声認識エンジン）のダウンロード

1. [whisper.cpp のリリースページ](https://github.com/ggml-org/whisper.cpp/releases) を開きます
2. 最新版の中から、以下のファイルをダウンロードします:
   - **CPU版（標準）**: `whisper-bin-x64.zip`
   - **GPU版（NVIDIA のグラフィックカードをお持ちの方）**: `whisper-cublas-12.4.0-bin-x64.zip` のような名前のファイル
     - ※ファイル名のバージョン番号（12.4.0など）は変わることがあります。`cublas` と `x64` が含まれているものを選んでください

3. ダウンロードした `.zip` ファイルを解凍（右クリック→「すべて展開」）します
4. 解凍したフォルダの中に入っている **`main.exe`（または `whisper-cli.exe`）** を **`whisper-cli.exe`** に名前を変更します
   - ※最初から `whisper-cli.exe` という名前の場合はそのままでOKです
5. 名前を変更した `whisper-cli.exe` と、一緒に入っている **`*.dll`** 系のファイルをすべて、このシステムの **`bin`** フォルダにコピーします

> 📁 **`bin` フォルダがない場合:**
> このREADMEと同じ場所に「bin」という名前のフォルダを新規作成してください

---

### ステップ3: AIモデル（音声認識用の辞書）のダウンロード

1. [Hugging Face のモデルページ](https://huggingface.co/ggerganov/whisper.cpp/tree/main) を開きます
2. 以下のいずれかのモデルファイルをダウンロードします（お好みで選んでください）:
   - **`ggml-small.bin`** (おすすめ・標準): バランスが良く、一般的な用途向け
   - **`ggml-base.bin`**: 軽量・高速だが精度はやや低め
   - **`ggml-medium.bin`**: 高精度だが変換に時間がかかる
   - **`ggml-large-v3.bin`**: 最高精度だがかなり重い（高性能PC推奨）

3. ダウンロードしたファイルを、このシステムの **`models`** フォルダに入れます

> 📁 **`models` フォルダがない場合:**
> このREADMEと同じ場所に「models」という名前のフォルダを新規作成してください

> 💡 **ヒント**: まずは `ggml-small.bin` を試して、もっと精度を上げたい場合は `medium` や `large` に切り替えてみてください

---

### ステップ4: 必要なプログラムのインストール

1. このフォルダにある **`install.bat`** をダブルクリックします
2. 黒い画面（コマンドプロンプト）が開いて、自動的にプログラムがインストールされます
3. 「**Installation complete!**」と表示されたら、完了です！ウィンドウを閉じてください

---

## 🎤 使い方

### 起動方法

**`launch.vbs`** をダブルクリックします。
- 何も画面は出ませんが、画面左上に **緑色のマイクアイコン** が表示されれば起動成功です🎉

### 音声入力する

**方法1: マイクアイコンをクリック**
1. 画面左上の **緑のマイクアイコン** をクリック
2. 「ピッ🔴」と音が鳴り、アイコンが **赤色** に変わったら喋り始めます
3. 話し終わったら、もう一度アイコンをクリック
4. 「ピピッ🟢」と音が鳴り、**文字がクリップボードに保存されます**（カーソル位置には自動入力されません）

**方法2: ホットキー（ショートカットキー）を使う**
1. キーボードの **`Ctrl` + `Alt` + `Shift` + `J`** を同時に押します（初期設定）
2. 「ピッ🔴」と音が鳴ったら喋ります
3. 話し終わったら、もう一度同じキーを押します
4. 「ピピッ🟢」と音が鳴り、**文字がクリップボードに保存されます**（カーソル位置には自動入力されません）

> ⌨️ **録音をキャンセルしたい場合:**
> 録音中（赤いマイクの状態）に **`Esc` キー** を押すと、録音がキャンセルされます

### 文字を貼り付ける

> 📋 **重要**: このシステムは、カーソルがある場所に自動的にテキストを入力するのではなく、**クリップボードに保存する**仕組みです。そのため、**`Ctrl` + `V`** でどこにでも自由に貼り付けることができます。

クリップボードに保存された文字を貼り付けるには:
1. テキストを入力したい場所（メモ帳、Word、ブラウザ、LINE など）をクリックしてカーソルを置きます
2. **`Ctrl` + `V`** を押すと、音声認識された文字が入力されます

### 終了する

このシステムを終了させるには:
1. 画面左上の **マイクアイコン**（緑色または赤色）に **マウスカーソルを合わせます**
2. **右クリック** を押します
3. 表示されたメニューから **「Exit」** をクリックします

> ⚠️ **注意**: ×ボタンで閉じるウィンドウはありません。必ず上記の手順で終了してください。

---

## 🔧 便利な設定（カスタマイズ）

### ショートカットをタスクバーに追加する

毎回フォルダを開いて `launch.vbs` をダブルクリックするのは面倒ですよね。タスクバーに登録すれば、ワンクリックで起動できます！
vbsファイルのショートカット作成は少し手間がかかります。下記の記事を参考にしてください

[batファイルをタスクバーに固定したい](https://qiita.com/GeneLab_999/items/2ea97f56a3db10ff6016)

### 設定ファイルの編集

`config.json` というファイルをメモ帳で開くと、細かい設定を変更できます。

> 📁 **config.json がない場合**: このフォルダに `config.default.json` があります。これをコピーして `config.json` を作成してください。`config.json` は個人設定用なので、リポジトリには含まれていません。

**主な設定項目:**
- **`"sound_enabled"`**: 効果音のオン/オフ
  - `true`: 音あり（デフォルト）
  - `false`: 音なし

- **`"n_gpu_layers"`**: GPU（グラフィックカード）の使用設定
  - `0`: CPU のみ使用（デフォルト）
  - `99`: GPU を最大限に使用
  - **重要**: 設定を変えるだけでは速くなりません。必ずGPU版のファイル（`whisper-cublas-12.4.0-bin-x64.zip` など）をダウンロードし、中身を `bin` フォルダに入れてください

- **`"hotkey"`**: ショートカットキーの割り当て変更
  - `"ctrl+alt+shift+j"`: 初期設定
  - お好みの組み合わせに変更できます（例: `"ctrl+shift+r"`）

- **`"auto_paste"`**: 自動貼り付け機能
  - `true`: 変換後、自動的に貼り付けまで行う
  - `false`: クリップボードにコピーのみ（手動で `Ctrl+V` で貼り付け）

- **`"language"`**: 認識言語の設定
  - `"ja"`: 日本語（デフォルト）
  - `"en"`: 英語など、他の言語コードに変更可能

- **`"model_path"`**: 使用するAIモデルのパス
  - `"./models/ggml-medium.bin"`: デフォルト
  - 他のモデルファイルのパスに変更可能

- **`"whisper_cli_path"`**: Whisper CLI実行ファイルのパス
  - `"./bin/whisper-cli.exe"`: デフォルト
  - 必要に応じて変更

- **`"keep_trailing_newline"`**: 末尾の改行を保持するかどうか
  - `false`: 保持しない（デフォルト）
  - `true`: 保持する

- **`"temp_dir"`**: 一時ファイル保存ディレクトリ
  - `""`: デフォルト（システムの一時ディレクトリを使用）
  - 特定のパスを指定可能

- **`"audio_device"`**: 使用するオーディオデバイス
  - `null`: デフォルト（システムデフォルト）
  - デバイス番号を指定可能

- **`"sample_rate"`**: オーディオサンプルレート
  - `44100`: デフォルト
  - 他のレートに変更可能

- **`"initial_prompt"`**: 初期プロンプト（認識精度向上のためのヒント）
  - 日本語のデフォルトプロンプトが設定されています
  - 必要に応じて変更
  - ⚠️ **品質に関する注意**: テキスト生成の品質が悪い場合、イニシャルプロンプトが長すぎる可能性があります
  - 特に **`ggml-large-v3-turbo.bin`** などのTurboモデルを使用している場合、イニシャルプロンプトを短くするか空にすることで品質が向上する場合があります
  - 例: `"initial_prompt": ""` (空にする) または `"initial_prompt": "日本語の音声認識"` (短くする)

- **`"best_of"`**: ベストオブパラメータ（変換候補数）
  - `5`: デフォルト
  - 数値を変更可能

- **`"beam_size"`**: ビームサイズ（検索幅）
  - `5`: デフォルト
  - 数値を変更可能

- **`"temperature"`**: 温度パラメータ（ランダム性）
  - `0.0`: デフォルト（決定論的）
  - 0.0-1.0の範囲で変更可能

- **`"carry_initial_prompt"`**: 初期プロンプトを継続して使用するかどうか
  - `true`: 使用する（デフォルト）
  - `false`: 使用しない

**設定例:**
```json
{
  "sound_enabled": true,
  "n_gpu_layers": 99,
  "hotkey": "ctrl+alt+shift+j",
  "auto_paste": false,
  "language": "ja",
  "model_path": "./models/ggml-medium.bin",
  "whisper_cli_path": "./bin/whisper-cli.exe",
  "keep_trailing_newline": false,
  "temp_dir": "",
  "audio_device": null,
  "sample_rate": 44100,
  "initial_prompt": "日本語の音声認識を行います。以下の文章は日本語で、日常会話やビジネス文書の内容です。句読点や改行を適切に挿入してください。専門用語や固有名詞は正確に認識してください。",
  "best_of": 5,
  "beam_size": 5,
  "temperature": 0.0,
  "carry_initial_prompt": true
}
```

### 🚀 詳しく解説: GPUを使って爆速にする方法

NVIDIA製のグラフィックボード（GeForceなど）をお持ちの方は、以下の手順で劇的に速くなります。

1. **GPU版のWhisperをダウンロード**
   - [リリースページ](https://github.com/ggml-org/whisper.cpp/releases) から `whisper-cublas-12.4.0-bin-x64.zip` のようなファイルをダウンロード

2. **ファイルを入れ替える**
   - 解凍して出てきた `main.exe` を **`whisper-cli.exe`** にリネーム
   - これと、一緒に入っているDLLファイル（`cublas64_11.dll` など）をすべて `bin` フォルダに入れて上書き保存

3. **設定を変更する**
   - `config.json` を開き、`"n_gpu_layers"` の数字を `0` から `99` に書き換えて保存

4. **再起動**
   - `launch.vbs` をダブルクリックして再起動すれば完了です！

---

## ❓ 困ったときは（トラブルシューティング）

### 起動しない

**症状:** `launch.vbs` をダブルクリックしても何も起こらない、またはエラーが出る

**対処法:**
1. **`debug.bat`** をダブルクリックしてください
2. 黒い画面にエラーメッセージが表示されます
3. エラー内容を確認して、以下の該当する項目をチェックしてください

**よくあるエラー:**
- **「python が見つかりません」**: Python がインストールされていないか、環境変数が設定されていません → ステップ1を再確認
- **「ModuleNotFoundError」**: 必要なライブラリがインストールされていません → `install.bat` を再実行してください
- **「whisper-cli.exe が見つかりません」**: `bin` フォルダに Whisper 本体がコピーされていません → ステップ2を再確認

### 文字起こしされない・変換が始まらない

**チェック項目:**
1. **`bin` フォルダに `whisper-cli.exe` がありますか？**
   - フォルダを開いて、`whisper-cli.exe` というファイルが存在するか確認してください
   - ない場合は、ステップ2を再実行してください

2. **`models` フォルダにモデルファイル（`.bin`）がありますか？**
   - `ggml-small.bin` などのファイルが存在するか確認してください
   - ない場合は、ステップ3を再実行してください

3. **マイクが正しく接続されていますか？**
   - Windowsの「設定」→「システム」→「サウンド」→「入力」でマイクが認識されているか確認してください

### 録音はできるが、文字が出てこない

**対処法:**
1. 使用しているモデルファイル（`ggml-small.bin` など）が正しくダウンロードできているか確認してください
   - ファイルサイズが極端に小さい場合、ダウンロードが途中で止まっている可能性があります
2. `config.json` の設定が正しいか確認してください
3. `debug.bat` を実行して、詳細なログを確認してください

### 変換された文字の品質が悪い・誤認識が多い

**対処法:**
1. **イニシャルプロンプトを調整する**: `config.json` の `"initial_prompt"` が長すぎる可能性があります
   - 特に **`ggml-large-v3-turbo.bin`** などのTurboモデルを使用している場合、イニシャルプロンプトを短くするか空にすると品質が向上することがあります
   - 試してみる設定:
     ```json
     "initial_prompt": ""
     ```
     または
     ```json
     "initial_prompt": "日本語の音声認識"
     ```
2. **より高精度なモデルを使う**: `ggml-small.bin` よりも `ggml-medium.bin` や `ggml-large-v3.bin` を試してみてください
3. **マイクの音質を確認**: 周囲のノイズが多い場合、静かな環境で試すか、品質の良いマイクを使用してください
4. **はっきりと話す**: ゆっくりと明瞭に話すと認識精度が向上します

### 変換速度が遅い

**対処法:**
1. **軽量モデルを使う**: `ggml-small.bin` の代わりに `ggml-base.bin` を試してみてください
2. **GPUを使う**（NVIDIA GeForce などのGPUをお持ちの場合）:
   - GPU版の Whisper（`whisper-cublas-12.4.0-bin-x64.zip`）を `bin` フォルダにコピー
   - `config.json` の `"n_gpu_layers"` を `99` に変更
3. **他のアプリケーションを閉じる**: ブラウザや動画再生ソフトなど、CPUやメモリを多く使うアプリを終了させてみてください
4. **システムを再起動する**: 一時的な負荷をクリアするために、パソコンを再起動してみてください
5. **サンプルレートを下げる**: `config.json` の `"sample_rate"` を `22050` などに変更して、処理負荷を軽減
6. **変換パラメータを調整**: `config.json` の `"best_of"` や `"beam_size"` を `3` などの小さい値に変更
7. **CPU使用時はGPU設定を確認**: `config.json` の `"n_gpu_layers"` が `0` になっているか確認（GPU版を使用していない場合）

### 音が鳴らない

**対処法:**
1. `config.json` を開いて、`"sound_enabled"` が `true` になっているか確認してください
2. Windowsの音量がミュートになっていないか確認してください

### ホットキーが反応しない

**対処法:**
1. 他のアプリケーションが同じキーの組み合わせを使っていないか確認してください
2. `config.json` の `"hotkey"` 設定を別のキーの組み合わせに変更してみてください

---

## 📝 その他の情報

### ログファイル

問題が発生した場合、`logs` フォルダ内のログファイルを確認すると、詳細な情報が記録されています。

### フォルダ構成

正しくセットアップできていれば、以下のようなフォルダ構成になっているはずです:

```
stt_whisper/
├── bin/
│   ├── whisper-cli.exe
│   └── *.dll (複数のDLLファイル)
├── models/
│   └── ggml-small.bin (または他のモデル)
├── logs/
├── config.json
├── install.bat
├── launch.vbs
├── debug.bat
└── README.md (このファイル)
```

---

## 🎉 これで準備完了です！

何か困ったことがあれば、`debug.bat` を実行してエラーメッセージを確認するか、このREADMEのトラブルシューティングセクションを参照してください。

快適な音声入力ライフをお楽しみください！🎤✨
